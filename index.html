<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Gradle-packer-plugin : Android Multi Packer Gradle Plugin">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Gradle-packer-plugin</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/mcxiaoke/gradle-packer-plugin">View on GitHub</a>

          <h1 id="project_title">Gradle-packer-plugin</h1>
          <h2 id="project_tagline">Android Multi Packer Gradle Plugin</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/mcxiaoke/gradle-packer-plugin/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/mcxiaoke/gradle-packer-plugin/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>
<a id="android多渠道打包工具gradle插件" class="anchor" href="#android%E5%A4%9A%E6%B8%A0%E9%81%93%E6%89%93%E5%8C%85%E5%B7%A5%E5%85%B7gradle%E6%8F%92%E4%BB%B6" aria-hidden="true"><span class="octicon octicon-link"></span></a>Android多渠道打包工具Gradle插件</h1>

<h2>
<a id="最新版本" class="anchor" href="#%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC" aria-hidden="true"><span class="octicon octicon-link"></span></a>最新版本</h2>

<ul>
<li>
<a href="http://search.maven.org/#artifactdetails%7Ccom.mcxiaoke.gradle%7Cpacker%7C1.0.0%7Cjar"><img src="http://img.shields.io/badge/2014.12.20-com.mcxiaoke.gradle:packer:1.0.0-brightgreen.svg" alt="Maven Central"></a> </li>
</ul>

<h2>
<a id="项目介绍" class="anchor" href="#%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D" aria-hidden="true"><span class="octicon octicon-link"></span></a>项目介绍</h2>

<p><strong>gradle-packer-plugin</strong> 是Android多渠道打包工具Gradle插件，可方便的于自动化构建系统集成，通过很少的配置可实现如下功能 ：</p>

<ul>
<li>支持自动替换AndroidManifest文件中的meta-data字段实现多渠道打包</li>
<li>支持自定义多渠道打包输出的存放目录和最终APK文件名</li>
<li>支持自动修改versionName中的build版本号，实现版本号自动增长</li>
</ul>

<p><strong>gradle-packer-plugin</strong> 库路径： <code>com.mcxiaoke.gradle:packer:1.0.+</code> 简短名：<code>packer</code>，可以在项目的 <code>build.gradle</code> 中指定使用</p>

<h2>
<a id="参与开发" class="anchor" href="#%E5%8F%82%E4%B8%8E%E5%BC%80%E5%8F%91" aria-hidden="true"><span class="octicon octicon-link"></span></a>参与开发</h2>

<p><code>plugin</code> 目录是插件的源代码，用 <code>Groovy</code> 语言编写，项目 <code>sample</code> 目录是一个完整的Andoid项目示例，在项目根目录有几个脚本可以用于测试：</p>

<ul>
<li>
<strong>deploy-local.sh</strong> 部署插件到本地的 <code>/tmp/repo/</code> 目录，方便即时测试</li>
<li>
<strong>test-build.sh</strong> 部署并测试插件是否有错误，测试build版本号自增功能</li>
<li>
<strong>test-market.sh</strong> 部署并测试插件是否有错误，测试多渠道打包功能 </li>
</ul>

<h2>
<a id="使用方法" class="anchor" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95" aria-hidden="true"><span class="octicon octicon-link"></span></a>使用方法</h2>

<h4>
<a id="修改项目根目录的-buildgradle-" class="anchor" href="#%E4%BF%AE%E6%94%B9%E9%A1%B9%E7%9B%AE%E6%A0%B9%E7%9B%AE%E5%BD%95%E7%9A%84-buildgradle-" aria-hidden="true"><span class="octicon octicon-link"></span></a>修改项目根目录的 <code>build.gradle</code> ：</h4>

<div class="highlight highlight-groovy"><pre>
buildscript {
    repositories {
        mavenCentral()
    }

    dependencies{
        classpath <span class="pl-s1"><span class="pl-pds">'</span>com.mcxiaoke.gradle:packer:1.0.+<span class="pl-pds">'</span></span>
    }
}  </pre></div>

<h4>
<a id="修改android项目的-buildgradle-" class="anchor" href="#%E4%BF%AE%E6%94%B9android%E9%A1%B9%E7%9B%AE%E7%9A%84-buildgradle-" aria-hidden="true"><span class="octicon octicon-link"></span></a>修改Android项目的 <code>build.gradle</code> :</h4>

<div class="highlight highlight-groovy"><pre>
apply <span class="pl-c1">plugin</span>: <span class="pl-s1"><span class="pl-pds">'</span>packer<span class="pl-pds">'</span></span>  </pre></div>

<h3>
<a id="多渠道打包" class="anchor" href="#%E5%A4%9A%E6%B8%A0%E9%81%93%E6%89%93%E5%8C%85" aria-hidden="true"><span class="octicon octicon-link"></span></a>多渠道打包</h3>

<p>需要在命令行指定 -Pmarket=yourMarketFileName属性，market是你的渠道名列表，一行一个渠道，名字和注释用#号分割，举例： <code>Google_Play#build for google play store</code> </p>

<h3>
<a id="文件名格式" class="anchor" href="#%E6%96%87%E4%BB%B6%E5%90%8D%E6%A0%BC%E5%BC%8F" aria-hidden="true"><span class="octicon octicon-link"></span></a>文件名格式</h3>

<p>可以使用 <code>archiveNameFormat</code> 自定义渠道打包输出的APK文件名格式，默认格式是 <code>${appPkg}-${flavorName}-${buildType}-v${versionName}-${versionCode}</code> 举例：假如你的App包名是  <code>com.your.company</code> ，渠道名是 <code>Google_Play</code> ，<code>buildType</code> 是 <code>release</code> ，<code>versionName</code> 是 <code>2.1.15</code> ，<code>versionCode</code> 是 <code>200115</code> ，那么生成的APK的文件名是 <code>com.your.company-Google_Player-release-2.1.15-20015.apk</code> </p>

<h3>
<a id="渠道列表格式" class="anchor" href="#%E6%B8%A0%E9%81%93%E5%88%97%E8%A1%A8%E6%A0%BC%E5%BC%8F" aria-hidden="true"><span class="octicon octicon-link"></span></a>渠道列表格式</h3>

<p>渠道名列表文件是纯文本文件，每行一个渠道号，渠道名和注释之间用 <code>#</code> 号分割开，行示例： <code>Google_Play#play store market</code>，会自动忽略空白行，格式不规范会报错</p>

<h3>
<a id="版本号自增" class="anchor" href="#%E7%89%88%E6%9C%AC%E5%8F%B7%E8%87%AA%E5%A2%9E" aria-hidden="true"><span class="octicon octicon-link"></span></a>版本号自增</h3>

<p>版本号自动会自动在在 <code>vesionName</code> 尾部增加 <code>.buildNumer</code> 该字段会自动增长，举例：如果App本来的版本号是 1.2.3，那么使用版本号自动后会是 <code>1.2.3.1</code> <code>1.2.3.2</code> ... <code>1.2.3.25</code> 末尾的build版本号会随构建次数自动增长。注意：如果在命令行使用 <code>-PbuildNum=123</code> 这种形式指定了build版本号，那么自增版本号不会生肖</p>

<h2>
<a id="配置选项" class="anchor" href="#%E9%85%8D%E7%BD%AE%E9%80%89%E9%A1%B9" aria-hidden="true"><span class="octicon octicon-link"></span></a>配置选项</h2>

<ul>
<li><p><strong>archiveOutput</strong>  指定渠道打包输出的APK存放目录，默认位于<code>${项目根目录}/build/archives</code>   </p></li>
<li>
<p><strong>archiveNameFormat</strong> - <code>Groovy格式字符串</code>， 指定渠道打包输出的APK文件名格式，默认文件名格式是： <code>${appPkg}-${flavorName}-${buildType}-v${versionName}-${versionCode}</code>，可使用以下变量:  </p>

<ul>
<li>
<em>projectName</em> - 项目名字</li>
<li>
<em>appName</em> - App模块名字</li>
<li>
<em>appPkg</em> - App包名 (<code>applicationId</code>或<code>packageName</code>)</li>
<li>
<em>buildType</em> - <code>buildType</code> (release/debug/beta等)</li>
<li>
<em>flavorName</em> - <code>flavorName</code> (对应渠道打包中的渠道名字)</li>
<li>
<em>versionName</em> - <code>versionName</code> (显示用的版本号)</li>
<li>
<em>versionCode</em> - <code>versionCode</code> (内部版本号)</li>
<li>
<em>buildTime</em> - <code>buildTime</code> (编译构建日期时间)</li>
</ul>
</li>
<li><p><strong>manifestMatcher</strong> 指定渠道打包需要修改的AndroidManifest.xml的meta-data的项名称，列表类型，举例： <code>['UMENG_CHANNEL', 'Promotion_Market']</code>，注意：需要同时在命令行使用 <code>-Pmarket=yourMarketFileName</code> 指定market属性多渠道打包才会生效 </p></li>
<li><p><strong>buildNumberAuto</strong> - 布尔值，是否使用自增版本号功能 设为 <code>true</code> 为使用插件提供的自增build版本号功能，该功能会在项目目录生成一个 <code>packer.properties</code> 文件，建议加入到 <code>.gitignore</code> 中，注意：该功能不会应用于多渠道打包生成的APK，不会影响渠道打包</p></li>
<li><p><strong>buildNumberTypeMatcher</strong> - 指定需要使用自增版本号的buildType，列表类型，举例： <code>['release', 'beta']</code> 默认是全部</p></li>
</ul>

<h2>
<a id="使用示例" class="anchor" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B" aria-hidden="true"><span class="octicon octicon-link"></span></a>使用示例：</h2>

<h3>
<a id="多渠道打包-1" class="anchor" href="#%E5%A4%9A%E6%B8%A0%E9%81%93%E6%89%93%E5%8C%85-1" aria-hidden="true"><span class="octicon octicon-link"></span></a>多渠道打包</h3>

<ul>
<li>修改项目根目录的 <code>build.gradle</code> 在 <code>buildscript.dependencies</code> 部分加入 <code>classpath 'com.mcxiaoke.gradle:packer:1.0.0'</code><br>
</li>
<li>修改Android项目的 <code>build.gradle</code> 在 <code>apply plugin: 'com.android.application'</code> 下面加入 <code>apply plugin: 'packer'</code><br>
</li>
<li>修改Android项目的 <code>build.gradle</code> 加入如下配置项，<code>manifestMatcher</code> 是必须指定的，其它几项可以使用默认值：<br>
</li>
</ul>

<div class="highlight highlight-groovy"><pre>
packer {
    <span class="pl-c">// 指定渠道打包输出目录</span>
    <span class="pl-c">// archiveOutput = file(new File(project.rootProject.buildDir.path, "archives"))</span>
    <span class="pl-c">// 指定渠道打包输出文件名格式</span>
    <span class="pl-c">// archiveNameFormat = ''</span>
    <span class="pl-c">// 指定渠道打包需要修改的AndroidManifest文件项</span>
    manifestMatcher <span class="pl-k">=</span> [<span class="pl-s1"><span class="pl-pds">'</span>UMENG_CHANNEL<span class="pl-pds">'</span></span>,<span class="pl-s1"><span class="pl-pds">'</span>Promotion_Market<span class="pl-pds">'</span></span>]

}
</pre></div>

<ul>
<li>假设渠道列表文件位于项目根目录，文件名为 <code>markets.txt</code> ，在项目根目录打开shell运行命令：</li>
</ul>

<div class="highlight highlight-shell"><pre>./gradlew -Pmarket=markets.txt clean archiveApkRelease</pre></div>

<pre><code>如果没有错误，打包完成后你可以在 `${项目根目录}/build/archives/` 目录找到最终的渠道包。说明：渠道打包的Gradle Task名字是 `archiveApk${buildType}` buildType一般是release，也可以是你自己指定的beta或者someOtherType，使用时首字母需要大写，例如release的渠道包任务名是 `archiveApkRelease`
</code></pre>

<h3>
<a id="版本号自增-1" class="anchor" href="#%E7%89%88%E6%9C%AC%E5%8F%B7%E8%87%AA%E5%A2%9E-1" aria-hidden="true"><span class="octicon octicon-link"></span></a>版本号自增</h3>

<ul>
<li>修改项目根目录的 <code>build.gradle</code> 在 <code>buildscript.dependencies</code> 部分加入 <code>classpath 'com.mcxiaoke.gradle:packer:1.0.0'</code><br>
</li>
<li>修改Android项目的 <code>build.gradle</code> 在 <code>apply plugin: 'com.android.application'</code> 下面加入 <code>apply plugin: 'packer'</code><br>
</li>
<li>修改Android项目的 <code>build.gradle</code> 加入如下配置项，buildNumberAuto是开关</li>
</ul>

<div class="highlight highlight-groovy"><pre>
packer {
    <span class="pl-c">// 指定是否使用build版本号自增</span>
    buildNumberAuto <span class="pl-k">=</span> <span class="pl-c1">true</span>
    <span class="pl-c">// 指定使用版本号自增的buildType，默认是全部</span>
    buildNumberTypeMatcher <span class="pl-k">=</span> [<span class="pl-s1"><span class="pl-pds">'</span>release<span class="pl-pds">'</span></span>, <span class="pl-s1"><span class="pl-pds">'</span>beta<span class="pl-pds">'</span></span>]

}
</pre></div>

<ul>
<li>在项目根目录打开shell运行命令： <code>./gradlew clean assembleRelease</code>  如果没有错误，你可以安装apk查看versionName自增是否生效， 也可以运行 <code>./gradlew -PbuildNum=123 clean assembleRelease</code> 从命令行指定build版本号，该方法多用于自动化构建系统</li>
</ul>

<h2>
<a id="完整示例" class="anchor" href="#%E5%AE%8C%E6%95%B4%E7%A4%BA%E4%BE%8B" aria-hidden="true"><span class="octicon octicon-link"></span></a>完整示例：</h2>

<p>项目的 <code>samples</code> 目录包含一个完整的项目示例，可以查看其中的 <code>build.gradle</code> </p>

<div class="highlight highlight-groovy"><pre>
buildscript {
    repositories {
        mavenCentral()
    }
    dependencies {
        classpath <span class="pl-s1"><span class="pl-pds">'</span>com.android.tools.build:gradle:1.0.0<span class="pl-pds">'</span></span>
        <span class="pl-c">// `添加packer插件依赖`</span>
        classpath <span class="pl-s1"><span class="pl-pds">'</span>com.mcxiaoke.gradle:packer:1.0.0<span class="pl-pds">'</span></span>
    }
}

repositories {
    mavenCentral()
}

apply <span class="pl-c1">plugin</span>: <span class="pl-s1"><span class="pl-pds">'</span>com.android.application<span class="pl-pds">'</span></span>
<span class="pl-c">// 建议放在 `com.android.application` 下面  </span>
<span class="pl-c">// `使用 apply plugin使用packer插件`  </span>
apply <span class="pl-c1">plugin</span>: <span class="pl-s1"><span class="pl-pds">'</span>packer<span class="pl-pds">'</span></span>

packer {
    <span class="pl-c">// 指定渠道打包输出目录</span>
    archiveOutput <span class="pl-k">=</span> file(<span class="pl-k">new</span> <span class="pl-st">File</span>(project<span class="pl-k">.</span>rootProject<span class="pl-k">.</span>buildDir<span class="pl-k">.</span>path, <span class="pl-s1"><span class="pl-pds">"</span>apks<span class="pl-pds">"</span></span>))
    <span class="pl-c">// 指定渠道打包输出文件名格式</span>
    archiveNameFormat <span class="pl-k">=</span> <span class="pl-s1"><span class="pl-pds">'</span><span class="pl-pds">'</span></span>
    <span class="pl-c">// 指定渠道打包需要修改的AndroidManifest文件项</span>
    manifestMatcher <span class="pl-k">=</span> [<span class="pl-s1"><span class="pl-pds">'</span>UMENG_CHANNEL<span class="pl-pds">'</span></span>,<span class="pl-s1"><span class="pl-pds">'</span>Promotion_Market<span class="pl-pds">'</span></span>]
    <span class="pl-c">// 指定是否使用build版本号自增</span>
    buildNumberAuto <span class="pl-k">=</span> <span class="pl-c1">true</span>
    <span class="pl-c">// 指定使用版本号自增的buildType，默认是全部</span>
    buildNumberTypeMatcher <span class="pl-k">=</span> [<span class="pl-s1"><span class="pl-pds">'</span>release<span class="pl-pds">'</span></span>, <span class="pl-s1"><span class="pl-pds">'</span>beta<span class="pl-pds">'</span></span>]

}

android {
    compileSdkVersion <span class="pl-c1">21</span>
    buildToolsVersion <span class="pl-s1"><span class="pl-pds">"</span>21.1.1<span class="pl-pds">"</span></span>

    defaultConfig {
        applicationId <span class="pl-s1"><span class="pl-pds">"</span>com.mcxiaoke.packer.sample<span class="pl-pds">"</span></span>
        minSdkVersion <span class="pl-c1">15</span>
        targetSdkVersion <span class="pl-c1">21</span>
        versionCode <span class="pl-c1">12345</span>
        versionName <span class="pl-s1"><span class="pl-pds">"</span>1.2.3<span class="pl-pds">"</span></span>
    }

    signingConfigs {
        release {
            storeFile file(<span class="pl-s1"><span class="pl-pds">"</span>android.keystore<span class="pl-pds">"</span></span>)
            storePassword <span class="pl-s1"><span class="pl-pds">"</span>android<span class="pl-pds">"</span></span>
            keyAlias <span class="pl-s1"><span class="pl-pds">"</span>android<span class="pl-pds">"</span></span>
            keyPassword <span class="pl-s1"><span class="pl-pds">"</span>android<span class="pl-pds">"</span></span>
        }
    }

    buildTypes {
        release {
            signingConfig signingConfigs<span class="pl-k">.</span>release
            minifyEnabled <span class="pl-c1">false</span>
        }

        beta {
            signingConfig signingConfigs<span class="pl-k">.</span>release
            minifyEnabled <span class="pl-c1">false</span>
            debuggable <span class="pl-c1">true</span>
        }

    }

}

dependencies {
    compile fileTree(<span class="pl-c1">dir</span>: <span class="pl-s1"><span class="pl-pds">'</span>libs<span class="pl-pds">'</span></span>, <span class="pl-c1">include</span>: [<span class="pl-s1"><span class="pl-pds">'</span>*.jar<span class="pl-pds">'</span></span>])
    compile <span class="pl-s1"><span class="pl-pds">'</span>com.android.support:support-v4:21.0.2<span class="pl-pds">'</span></span>
}

</pre></div>

<h2>
<a id="感谢" class="anchor" href="#%E6%84%9F%E8%B0%A2" aria-hidden="true"><span class="octicon octicon-link"></span></a>感谢</h2>

<p>本项目参考了公司内部Android项目使用的多渠道打包工具，最初作者是 <a href="https://github.com/googolmo">googolmo</a>，文件名模板自定义部分的代码修改自此项目 <a href="https://github.com/hamsterksu/android-appversion-gradle-plugin">android-appversion-gradle-plugin</a></p>

<h2>
<a id="项目许可" class="anchor" href="#%E9%A1%B9%E7%9B%AE%E8%AE%B8%E5%8F%AF" aria-hidden="true"><span class="octicon octicon-link"></span></a>项目许可</h2>

<pre><code>Copyright 2014 Xiaoke Zhang

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
</code></pre>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Gradle-packer-plugin maintained by <a href="https://github.com/mcxiaoke">mcxiaoke</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
